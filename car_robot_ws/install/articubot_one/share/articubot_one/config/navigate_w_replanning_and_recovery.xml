<root main_tree_to_execute="MainTree">
    <BehaviorTree ID="TopLevelTree">

    <RecoveryNode name="PersistentRecovery" number_of_retries="10">

      <!-- MAIN SYSTEM + BEHAVIOR TREE -->
      <Sequence name="RunFullBehavior">
        
        <!-- SYSTEM CHECK -->
        <Sequence name="SystemCheckSequence">
          <RecoveryNode name="LiDARRecovery" number_of_retries="3">
            <CheckTopicAlive topic="/scan" timeout="2.0"/>
          </RecoveryNode>

          <RecoveryNode name="CameraRecovery" number_of_retries="3">
            <CheckTopicAlive topic="/camera/image_raw" timeout="2.0"/>
          </RecoveryNode>

          <RecoveryNode name="DiffDriveControllerRecovery" number_of_retries="3">
            <CheckControllerAlive controller_name="diff_cont"/>
          </RecoveryNode>

          <RecoveryNode name="JointBroadcasterRecovery" number_of_retries="3">
            <CheckControllerAlive controller_name="joint_broad"/>
          </RecoveryNode>
        </Sequence>

        <!-- MAIN TASK BEHAVIOR TREE -->
        <SubTree ID="MainTree"/>
        
      </Sequence>

      <!-- Recovery behavior: try restarting system -->
      <RunSystemRecovery launch_script="/home/robogames/vt-cro/robogames_pi/car_robot_ws/system_recovery.sh"/>
    </RecoveryNode>

  </BehaviorTree>

  <BehaviorTree ID="MainTree">

    <!-- Recovery Node: If no cone detected, spin in place -->
    <RecoveryNode number_of_retries="3" name="RecoveryNode">
      <ReactiveFallback name="DetectOrRecover">
        <DetectObject object_type="cones_ramp" detected="{object_detected}"/>
        
        <Sequence name="RotateUntilConeFound">
          <Spin spin_dist="1.57"/> <!-- Rotate 90 degrees -->
          <Wait wait_duration="2"/>
        </Sequence>
      </ReactiveFallback>
    </RecoveryNode>

    <!-- Decision Tree -->
    <Switch3 variable="{object_detected}">
      
      <!-- Move Toward Yellow Cone and Turn Left -->
      <Case value="yellow">
        <Sequence name="TurnLeft">
          <NavigateToPose goal="{yellow_cone_location}"/>
          <Wait wait_duration="1"/>
          <Turn direction="left" angle="90"/>
        </Sequence>
      </Case>

      <!-- Move Toward Blue Cone and Turn Right -->
      <Case value="blue">
        <Sequence name="TurnRight">
          <NavigateToPose goal="{blue_cone_location}"/>
          <Wait wait_duration="1"/>
          <Turn direction="right" angle="90"/>
        </Sequence>
      </Case>

      <!-- If One Red Cone is Detected, Rotate Until Second Red Cone is Found -->
      <Case value="red">
        <ReactiveFallback name="FindSecondRed">
          <DetectObject object_type="red_cone" detected="{second_red_detected}"/>
          
          <Sequence name="RotateUntilBothRedFound">
            <Spin spin_dist="1.57"/>  <!--1.57 = pi/2-->
            <Wait wait_duration="2"/>
          </Sequence>
        </ReactiveFallback>
        
        <NavigateToPose goal="{middle_of_red_cones}"/>
      </Case>

      <!-- Move Towards Ramp and Climb -->
      <Case value="ramp">
        <Sequence name="ClimbRamp">
          <NavigateToPose goal="{ramp_location}"/>
          <Wait wait_duration="1"/>
          <NavigateToPose goal="{top_of_ramp}"/>
        </Sequence>
      </Case>
    
    </Switch3>
    
  </BehaviorTree>
</root>
